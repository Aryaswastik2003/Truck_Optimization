<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>🚛 Real-World Truck Optimizer</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --bg-card: #334155;
  --accent: #10b981;
  --accent-hover: #059669;
  --text-primary: #f1f5f9;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --border: #475569;
  --success: #22c55e;
  --warning: #f59e0b;
  --error: #ef4444;
  --glass: rgba(51, 65, 85, 0.8);
}

* { box-sizing: border-box; }
html, body { height: 100%; margin: 0; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
  color: var(--text-primary);
  padding: 20px;
  line-height: 1.6;
}

.container { max-width: 1400px; margin: 0 auto; }

.header {
  text-align: center;
  margin-bottom: 40px;
  padding: 30px;
  background: var(--glass);
  border-radius: 20px;
  backdrop-filter: blur(10px);
  border: 1px solid var(--border);
}

.header h1 {
  font-size: 2.5rem;
  margin: 0 0 10px 0;
  background: linear-gradient(135deg, var(--accent), #06d6a0);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.header p {
  color: var(--text-secondary);
  font-size: 1.1rem;
  margin: 0;
}

.grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 30px;
  margin-bottom: 30px;
}

.card {
  background: var(--glass);
  border-radius: 16px;
  padding: 25px;
  border: 1px solid var(--border);
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
}

.card h2 {
  color: var(--text-primary);
  margin: 0 0 20px 0;
  font-size: 1.4rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

.form-group {
  margin-bottom: 20px;
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 15px;
}

label {
  display: block;
  color: var(--text-secondary);
  font-size: 0.9rem;
  font-weight: 600;
  margin-bottom: 6px;
}

input, select {
  width: 100%;
  padding: 12px 16px;
  background: rgba(15, 23, 42, 0.8);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-primary);
  font-size: 0.95rem;
  transition: all 0.2s ease;
}

input:focus, select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
}

.btn {
  background: linear-gradient(135deg, var(--accent), var(--accent-hover));
  color: white;
  border: none;
  padding: 12px 24px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid transparent;
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
}

.btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.btn-secondary {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  background: var(--border);
  box-shadow: none;
}

.btn-small {
  padding: 8px 16px;
  font-size: 0.85rem;
}

.box-item {
  background: rgba(15, 23, 42, 0.5);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 15px;
  transition: all 0.2s ease;
}

.box-item:hover {
  border-color: var(--accent);
}

.box-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.box-type-select {
  flex: 1;
  margin-right: 15px;
}

.constraint-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.checkbox-group {
  display: flex;
  align-items: center;
  gap: 8px;
}

.checkbox-group input[type="checkbox"] {
  width: auto;
  margin: 0;
}

.results-section {
  grid-column: 1 / -1;
  margin-top: 20px;
}

.results-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.stability-indicator {
  padding: 10px 15px;
  border-radius: 8px;
  font-weight: 600;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.stability-safe {
  background: rgba(34, 197, 94, 0.2);
  color: var(--success);
  border: 1px solid var(--success);
}

.stability-warning {
  background: rgba(245, 158, 11, 0.2);
  color: var(--warning);
  border: 1px solid var(--warning);
}

.stability-danger {
  background: rgba(239, 68, 68, 0.2);
  color: var(--error);
  border: 1px solid var(--error);
}

.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.metric-card {
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  text-align: center;
}

.metric-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 5px;
}

.metric-label {
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.instructions-list {
  background: rgba(15, 23, 42, 0.4);
  border-radius: 12px;
  padding: 20px;
  max-height: 400px;
  overflow-y: auto;
}

.instruction-item {
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
  color: var(--text-secondary);
}

.instruction-item:last-child {
  border-bottom: none;
}

.instruction-item strong {
  color: var(--text-primary);
}

.alert {
  padding: 15px;
  border-radius: 10px;
  margin: 15px 0;
  border: 1px solid;
}

.alert-warning {
  background: rgba(245, 158, 11, 0.1);
  border-color: var(--warning);
  color: var(--warning);
}

.alert-error {
  background: rgba(239, 68, 68, 0.1);
  border-color: var(--error);
  color: var(--error);
}

.loader {
  display: inline-block;
  width: 20px;
  height: 20px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  border-radius: 50%;
  border-top-color: var(--accent);
  animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.visualization-container {
  background: rgba(15, 23, 42, 0.6);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  margin-top: 20px;
}

.truck-3d-view {
  width: 100%;
  height: 400px;
  background: linear-gradient(45deg, #1e293b, #334155);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
  font-style: italic;
}

@media (max-width: 768px) {
  .grid {
    grid-template-columns: 1fr;
  }
  
  .form-row {
    grid-template-columns: 1fr;
  }
  
  .constraint-grid {
    grid-template-columns: 1fr;
  }
  
  .metrics-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>🚛 Real-World Truck Optimizer</h1>
    <p>Physics-based 3D packing with real-world constraints & safety validation</p>
  </div>

  <div class="grid">
    <!-- Box Input Section -->
    <div class="card">
      <h2>📦 Box Specifications</h2>
      <div id="boxes-container"></div>
      <button id="add-box" class="btn btn-secondary btn-small">+ Add Another Box Type</button>
    </div>

    <!-- Truck Specification -->
    <div class="card">
      <h2>🚛 Truck Specifications</h2>
      <div class="form-group">
        <label>Truck Model</label>
        <select id="truck-select">
          <option value="">Select a truck model...</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Custom Truck (Optional)</label>
        <div class="form-row">
          <input type="text" id="custom-truck-name" placeholder="Truck name">
          <input type="number" id="custom-length" placeholder="Length (mm)">
          <input type="number" id="custom-width" placeholder="Width (mm)">
        </div>
        <div class="form-row" style="margin-top: 10px;">
          <input type="number" id="custom-height" placeholder="Height (mm)">
          <input type="number" id="custom-payload" placeholder="Max payload (kg)">
          <input type="number" id="custom-wheelbase" placeholder="Wheelbase (mm)">
        </div>
      </div>

      <div class="form-group">
        <label>Route Information</label>
        <div class="form-row">
          <input type="text" id="route-source" placeholder="Source city">
          <input type="text" id="route-destination" placeholder="Destination">
          <select id="route-type">
            <option value="highway">Highway</option>
            <option value="urban">Urban</option>
            <option value="mixed">Mixed</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="results-section card">
      <div class="results-header">
        <h2>📊 Optimization Results</h2>
        <button id="optimize-btn" class="btn">🚀 Optimize Loading</button>
      </div>
      
      <div id="results-content">
        <p style="color: var(--text-muted); text-align: center; padding: 40px;">
          Configure your boxes and truck, then click "Optimize Loading" to see results.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
// Box catalogue with real-world specifications
const BOX_CATALOGUE = {
  "Small Electronics Box": { 
    dims: [300, 200, 150], 
    weight: 5,
    fragility: "very_fragile",
    stackable: false,
    max_stack_weight: 0
  },
  "Standard Shipping Box": { 
    dims: [400, 300, 200], 
    weight: 3,
    fragility: "normal",
    stackable: true,
    max_stack_weight: 50
  },
  "Heavy Appliance Box": { 
    dims: [800, 600, 800], 
    weight: 45,
    fragility: "fragile",
    stackable: false,
    max_stack_weight: 0,
    orientation: "upright_only"
  },
  "Industrial Crate": { 
    dims: [1200, 800, 600], 
    weight: 80,
    fragility: "robust",
    stackable: true,
    max_stack_weight: 200
  },
  "Textile Bale": { 
    dims: [900, 700, 400], 
    weight: 25,
    fragility: "normal",
    stackable: true,
    max_stack_weight: 100
  },
  "Chemical Drum": { 
    dims: [600, 600, 900], 
    weight: 200,
    fragility: "normal",
    stackable: false,
    max_stack_weight: 0,
    orientation: "upright_only"
  },
  "Furniture Package": { 
    dims: [1500, 800, 200], 
    weight: 30,
    fragility: "fragile",
    stackable: true,
    max_stack_weight: 80
  }
};

let boxCounter = 0;
let defaultTrucks = [];

// Initialize the application
document.addEventListener('DOMContentLoaded', async function() {
  await loadDefaultTrucks();
  addBoxForm();
  setupEventListeners();
});

async function loadDefaultTrucks() {
  try {
    const response = await fetch('http://127.0.0.1:8000/api/default-trucks');
    if (response.ok) {
      defaultTrucks = await response.json();
      populateTruckSelect();
    }
  } catch (error) {
    console.error('Failed to load default trucks:', error);
    // Fallback trucks
    defaultTrucks = [
      {
        name: "Tata 407 (22 ft)",
        internal_length_mm: 6700,
        internal_width_mm: 2440,
        internal_height_mm: 2440,
        max_payload_kg: 7500,
        front_axle_limit_kg: 2500,
        rear_axle_limit_kg: 5000,
        wheelbase_mm: 3800,
        max_center_of_gravity_height_mm: 1800
      }
    ];
    populateTruckSelect();
  }
}

function populateTruckSelect() {
  const select = document.getElementById('truck-select');
  select.innerHTML = '<option value="">Select a truck model...</option>';
  
  defaultTrucks.forEach((truck, index) => {
    const option = document.createElement('option');
    option.value = index;
    option.textContent = `${truck.name} - ${truck.max_payload_kg}kg capacity`;
    select.appendChild(option);
  });
}

function addBoxForm() {
  const container = document.getElementById('boxes-container');
  const boxDiv = document.createElement('div');
  boxDiv.className = 'box-item';
  boxDiv.dataset.boxId = boxCounter++;
  
  boxDiv.innerHTML = `
    <div class="box-header">
      <select class="box-type-select">
        <option value="">Select box type...</option>
        ${Object.keys(BOX_CATALOGUE).map(name => 
          `<option value="${name}">${name}</option>`
        ).join('')}
      </select>
      <button class="btn btn-secondary btn-small remove-box" onclick="removeBox(this)">✕</button>
    </div>
    
    <div class="form-row">
      <div>
        <label>Length (mm)</label>
        <input type="number" class="box-length" min="1" required>
      </div>
      <div>
        <label>Width (mm)</label>
        <input type="number" class="box-width" min="1" required>
      </div>
      <div>
        <label>Height (mm)</label>
        <input type="number" class="box-height" min="1" required>
      </div>
    </div>
    
    <div class="form-row">
      <div>
        <label>Weight (kg)</label>
        <input type="number" class="box-weight" min="0.1" step="0.1" required>
      </div>
      <div>
        <label>Quantity</label>
        <input type="number" class="box-quantity" min="1" value="1" required>
      </div>
      <div>
        <label>Max Stack Weight (kg)</label>
        <input type="number" class="box-stack-weight" min="0" step="0.1">
      </div>
    </div>
    
    <div class="constraint-grid">
      <div>
        <label>Fragility</label>
        <select class="box-fragility">
          <option value="normal">Normal</option>
          <option value="fragile">Fragile</option>
          <option value="very_fragile">Very Fragile</option>
          <option value="robust">Robust</option>
        </select>
      </div>
      <div>
        <label>Orientation</label>
        <select class="box-orientation">
          <option value="any">Any Direction</option>
          <option value="upright_only">Upright Only</option>
          <option value="no_invert">No Inversion</option>
        </select>
      </div>
      <div>
        <label>Priority</label>
        <select class="box-priority">
          <option value="normal">Normal</option>
          <option value="first_out">First Out</option>
          <option value="last_out">Last Out</option>
        </select>
      </div>
      <div class="checkbox-group">
        <input type="checkbox" class="box-stackable" id="stackable-${boxDiv.dataset.boxId}" checked>
        <label for="stackable-${boxDiv.dataset.boxId}">Stackable</label>
      </div>
      <div class="checkbox-group">
        <input type="checkbox" class="box-bottom-support" id="support-${boxDiv.dataset.boxId}">
        <label for="support-${boxDiv.dataset.boxId}">Needs Full Support</label>
      </div>
    </div>
  `;
  
  container.appendChild(boxDiv);
  
  // Add event listener for box type selection
  const typeSelect = boxDiv.querySelector('.box-type-select');
  typeSelect.addEventListener('change', function() {
    updateBoxFromCatalogue(boxDiv, this.value);
  });
}

function updateBoxFromCatalogue(boxDiv, boxType) {
  if (!boxType || !BOX_CATALOGUE[boxType]) return;
  
  const spec = BOX_CATALOGUE[boxType];
  
  boxDiv.querySelector('.box-length').value = spec.dims[0];
  boxDiv.querySelector('.box-width').value = spec.dims[1];
  boxDiv.querySelector('.box-height').value = spec.dims[2];
  boxDiv.querySelector('.box-weight').value = spec.weight;
  boxDiv.querySelector('.box-stack-weight').value = spec.max_stack_weight || '';
  boxDiv.querySelector('.box-fragility').value = spec.fragility || 'normal';
  boxDiv.querySelector('.box-orientation').value = spec.orientation || 'any';
  boxDiv.querySelector('.box-stackable').checked = spec.stackable !== false;
}

function removeBox(button) {
  button.closest('.box-item').remove();
}

function setupEventListeners() {
  document.getElementById('add-box').addEventListener('click', addBoxForm);
  document.getElementById('optimize-btn').addEventListener('click', optimizeLoading);
}

function gatherBoxData() {
  const boxes = [];
  const boxItems = document.querySelectorAll('.box-item');
  
  boxItems.forEach(boxDiv => {
    const typeSelect = boxDiv.querySelector('.box-type-select');
    const boxType = typeSelect.value || 'Custom Box';
    
    const length = parseFloat(boxDiv.querySelector('.box-length').value);
    const width = parseFloat(boxDiv.querySelector('.box-width').value);
    const height = parseFloat(boxDiv.querySelector('.box-height').value);
    const weight = parseFloat(boxDiv.querySelector('.box-weight').value);
    const quantity = parseInt(boxDiv.querySelector('.box-quantity').value);
    const maxStackWeight = parseFloat(boxDiv.querySelector('.box-stack-weight').value) || null;
    
    if (length && width && height && weight && quantity) {
      boxes.push({
        box_type: boxType,
        length_mm: length,
        width_mm: width,
        height_mm: height,
        weight_kg: weight,
        quantity: quantity,
        fragility: boxDiv.querySelector('.box-fragility').value,
        orientation_constraint: boxDiv.querySelector('.box-orientation').value,
        loading_priority: boxDiv.querySelector('.box-priority').value,
        stackable: boxDiv.querySelector('.box-stackable').checked,
        requires_bottom_support: boxDiv.querySelector('.box-bottom-support').checked,
        max_stack_weight_kg: maxStackWeight,
        min_support_percentage: 80.0
      });
    }
  });
  
  return boxes;
}

function gatherTruckData() {
  const truckSelect = document.getElementById('truck-select');
  const selectedIndex = parseInt(truckSelect.value);
  
  if (!isNaN(selectedIndex) && defaultTrucks[selectedIndex]) {
    return defaultTrucks[selectedIndex];
  }
  
  // Check for custom truck data
  const customName = document.getElementById('custom-truck-name').value;
  const customLength = parseFloat(document.getElementById('custom-length').value);
  const customWidth = parseFloat(document.getElementById('custom-width').value);
  const customHeight = parseFloat(document.getElementById('custom-height').value);
  const customPayload = parseFloat(document.getElementById('custom-payload').value);
  const customWheelbase = parseFloat(document.getElementById('custom-wheelbase').value);
  
  if (customName && customLength && customWidth && customHeight && customPayload && customWheelbase) {
    return {
      name: customName,
      internal_length_mm: customLength,
      internal_width_mm: customWidth,
      internal_height_mm: customHeight,
      max_payload_kg: customPayload,
      front_axle_limit_kg: customPayload * 0.35, // Estimate 35% front
      rear_axle_limit_kg: customPayload * 0.65,  // Estimate 65% rear
      wheelbase_mm: customWheelbase,
      loading_height_mm: 1200,
      max_center_of_gravity_height_mm: customHeight * 0.75
    };
  }
  
  return null;
}

async function optimizeLoading() {
  const button = document.getElementById('optimize-btn');
  const resultsContent = document.getElementById('results-content');
  
  // Gather data
  const boxes = gatherBoxData();
  const truck = gatherTruckData();
  
  if (boxes.length === 0) {
    alert('Please add at least one box specification.');
    return;
  }
  
  if (!truck) {
    alert('Please select a truck or enter custom truck specifications.');
    return;
  }
  
  // Show loading state
  button.disabled = true;
  button.innerHTML = '<span class="loader"></span> Optimizing...';
  resultsContent.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loader" style="margin-bottom: 15px;"></div><p>Running real-world optimization with physics simulation...</p></div>';
  
  try {
    const response = await fetch('http://127.0.0.1:8000/api/optimize-real-world', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        boxes: boxes,
        truck: truck,
        route_stops: []
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${await response.text()}`);
    }
    
    const result = await response.json();
    displayResults(result);
    
  } catch (error) {
    console.error('Optimization failed:', error);
    resultsContent.innerHTML = `
      <div class="alert alert-error">
        <strong>Optimization Failed:</strong> ${error.message}
      </div>
    `;
  } finally {
    button.disabled = false;
    button.innerHTML = '🚀 Optimize Loading';
  }
}

function displayResults(result) {
  const resultsContent = document.getElementById('results-content');
  
  // Determine stability status
  const stability = result.stability_analysis;
  let stabilityClass = 'stability-safe';
  let stabilityIcon = '✅';
  let stabilityText = 'Safe & Stable';
  
  if (stability.issues && stability.issues.length > 0) {
    stabilityClass = 'stability-danger';
    stabilityIcon = '⛔';
    stabilityText = 'Unsafe - Issues Found';
  } else if (stability.warnings && stability.warnings.length > 0) {
    stabilityClass = 'stability-warning';
    stabilityIcon = '⚠️';
    stabilityText = 'Caution - Warnings';
  }
  
  resultsContent.innerHTML = `
    <div class="stability-indicator ${stabilityClass}">
      ${stabilityIcon} ${stabilityText}
    </div>
    
    ${stability.issues && stability.issues.length > 0 ? `
      <div class="alert alert-error">
        <strong>Safety Issues:</strong>
        <ul>
          ${stability.issues.map(issue => `<li>${issue}</li>`).join('')}
        </ul>
      </div>
    ` : ''}
    
    ${stability.warnings && stability.warnings.length > 0 ? `
      <div class="alert alert-warning">
        <strong>Warnings:</strong>
        <ul>
          ${stability.warnings.map(warning => `<li>${warning}</li>`).join('')}
        </ul>
      </div>
    ` : ''}
    
    <div class="metrics-grid">
      <div class="metric-card">
        <div class="metric-value">${result.packed_items}/${result.total_items}</div>
        <div class="metric-label">Items Packed</div>
      </div>
      <div class="metric-card">
        <div class="metric-value">${result.volume_utilization_pct}%</div>
        <div class="metric-label">Volume Utilization</div>
      </div>
      <div class="metric-card">
        <div class="metric-value">${result.weight_utilization_pct}%</div>
        <div class="metric-label">Weight Utilization</div>
      </div>
      <div class="metric-card">
        <div class="metric-value">${stability.weight_distribution_rear_pct.toFixed(1)}%</div>
        <div class="metric-label">Rear Axle Weight</div>
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
      <div>
        <h3>📋 Loading Instructions</h3>
        <div class="instructions-list">
          ${result.loading_instructions.map(instruction => `
            <div class="instruction-item">${instruction}</div>
          `).join('')}
        </div>
      </div>
      
      <div>
        <h3>📊 Technical Details</h3>
        <div class="instructions-list">
          <div class="instruction-item">
            <strong>Center of Gravity:</strong> 
            (${stability.center_of_gravity.map(v => v.toFixed(0)).join(', ')})mm
          </div>
          <div class="instruction-item">
            <strong>Axle Weights:</strong> 
            Front: ${stability.axle_weights[0].toFixed(0)}kg, 
            Rear: ${stability.axle_weights[1].toFixed(0)}kg
          </div>
          <div class="instruction-item">
            <strong>Total Weight:</strong> ${result.total_weight_kg}kg
          </div>
          <div class="instruction-item">
            <strong>Truck:</strong> ${result.truck_name}
          </div>
          ${result.unpacked_items.length > 0 ? `
            <div class="instruction-item">
              <strong>Unpacked Items:</strong> ${result.unpacked_items.join(', ')}
            </div>
          ` : ''}
        </div>
      </div>
    </div>
    
    <div class="visualization-container">
      <h3>🎯 3D Truck Visualization</h3>
      <div class="truck-3d-view">
        3D visualization would render here<br>
        <small>(Showing ${result.packed_items} items in optimized positions)</small>
      </div>
    </div>
  `;
}

// Initialize with one box form
addBoxForm();
</script>

</body>
</html>