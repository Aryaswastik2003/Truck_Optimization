<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>üöõ Truck Optimiser ‚Äî Demo</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{
  --bg-1:#f7fbf9;
  --bg-2:#eef6f1;
  --card:#ffffff;
  --accent:#16a34a;
  --accent-2:#10b981;
  --muted:#6b7280;
  --panel-shadow:0 8px 30px rgba(2,6,23,0.06);
  --glass:rgba(255,255,255,0.6);
  --accent-contrast:#063f2f;
}
html,body{height:100%;}
body{
  font-family:Inter,sans-serif;
  background:linear-gradient(135deg,var(--bg-1),var(--bg-2));
  color:#0f172a;
  padding:28px;
  line-height:1.45;
  margin:0;
}

h2{
  margin:0 0 12px 0;
  font-size:18px;
  font-weight:700;
  color:var(--accent-contrast);
  display:flex;
  align-items:center;
  gap:10px;
}

.card{
  background:var(--card);
  border-radius:14px;
  padding:18px;
  box-shadow:var(--panel-shadow);
  margin-bottom:18px;
  transition:transform .16s ease;
}

.card.small{padding:12px;border-radius:12px;}
label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted);font-weight:600;}
input[type="text"], input[type="number"], select{
  width:100%;padding:8px 10px;border-radius:10px;border:1px solid #e6eef0;background:#fbfdfb;
}
.row{display:flex;gap:12px;flex-wrap:wrap;}
.col{flex:1;min-width:200px;}
button{
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;
  box-shadow:0 6px 18px rgba(16,185,129,0.14);
}
button.secondary{background:#f3f4f6;color:#111;box-shadow:none;border:1px solid #e6eef0;}
button:disabled{opacity:.6;cursor:wait;}
.muted{color:var(--muted);font-size:13px;}
.small{font-size:13px;padding:6px 10px;}
.box-item{
  border:1px solid #eef2f7;
  padding:12px;
  border-radius:12px;
  margin-bottom:10px;
  background:linear-gradient(180deg,#ffffff,#fbfffb);
  display:flex;flex-direction:column;gap:8px;
}
.box-top{display:flex;gap:12px;align-items:center;}
.box-top .meta{font-size:13px;color:#0f172a;font-weight:600;}
.dims{font-size:12px;color:var(--muted);margin-top:4px;}
.results-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;}
.truck-card{padding:12px;border-radius:10px;background:linear-gradient(180deg,#ffffff,#f7fff7);border:1px solid #ecfdf5;}
.metric{font-weight:700;font-size:18px;color:var(--accent-contrast);}
.metric-small{font-size:12px;color:var(--muted);}
.loader{
  display:inline-block;width:18px;height:18px;
  border-radius:50%;
  border:3px solid rgba(255,255,255,0.2);
  border-top-color:white;
  animation:spin 1s linear infinite;
  margin-right:8px;
}
@keyframes spin{to{transform:rotate(360deg)}}
.boxes-compact{display:flex;gap:10px;flex-wrap:wrap;}
.pill{
  background:linear-gradient(90deg,#ecfdf5,#dcfce7);
  border:1px solid #bbf7d0;
  padding:6px 8px;border-radius:999px;font-size:12px;color:#065f46;font-weight:700;
}
.note{font-size:12px;color:var(--muted);margin-top:8px;}
</style>
</head>
<body>

<!-- Boxes Section -->
<div class="card">
  <h2>üì¶ Custom Outer Box Details</h2>
  <div id="boxes"></div>
  <div style="margin-top:10px;">
    <button id="addBox" class="small">+ Add Another Box Type</button>
    <span class="muted" style="margin-left:12px;">Pick from PRD catalogue. Edit qty or payload if needed.</span>
  </div>
</div>

<!-- Trucks Section -->
<div class="card">
  <h2>üõ£Ô∏è Route & Trucks</h2>
  <div class="row">
    <div class="col">
      <label>Source</label>
      <input id="source" type="text" placeholder="City or depot" />
    </div>
    <div class="col">
      <label>Destination</label>
      <input id="dest" type="text" placeholder="City or depot" />
    </div>
  </div>

  <div style="margin-top:12px" class="row">
    <div class="col">
      <label>Route Type</label>
      <div style="display:flex; gap:12px; align-items:center;">
        <label><input type="checkbox" id="highway" /> Highway</label>
        <label><input type="checkbox" id="semi" /> Semi-Urban</label>
        <label><input type="checkbox" id="village" /> Village</label>
      </div>
    </div>

    <div class="col">
      <label>Custom Trucks (optional)</label>
      <input id="truckNames" placeholder="22 ft Truck,32 ft Single Axle,32 ft Multi Axle" />
      <div style="display:flex; gap:8px; margin-top:6px;">
        <input id="truckDims" placeholder="6700x2440x2440;9750x2440x2440;9750x2440x2440" />
        <input id="truckPayloads" placeholder="7500,9000,16000" />
      </div>
      <div class="note">Leave blank to use default PRD trucks.</div>
    </div>
  </div>
</div>

<!-- Action Buttons -->
<div style="display:flex; gap:14px; margin-bottom:18px;">
  <button id="optBtn">‚ö° Optimize Trucks</button>
  <button id="resetBtn" class="secondary">Reset</button>
  <div style="flex:1"></div>
  <div class="boxes-compact" id="summaryPills"></div>
</div>

<!-- Results Section -->
<div class="card">
  <h2>üìä Results</h2>
  <div id="results" class="muted">No results yet.</div>
</div>

<script>
const BOX_CATALOGUE = {
  "Crate 400x300x120": { dims:[400,300,120], weight:15 },
  "Crate 400x300x235": { dims:[400,300,235], weight:15 },
  "Crate 600x400x120": { dims:[600,400,120], weight:15 },
  "Crate 600x400x180": { dims:[600,400,180], weight:15 },
  "Crate 600x400x235": { dims:[600,400,235], weight:15 },
  "Crate 600x400x348": { dims:[600,400,348], weight:15 },
  "PP Box": { dims:[1900,1200,800], weight:15 },
  "FLC 1200x1000x595": { dims:[1200,1000,595], weight:800 },
  "FLC 1200x1000x795": { dims:[1200,1000,795], weight:800 },
  "FLC 1200x1000x975": { dims:[1200,1000,975], weight:800 },
  "FLC 1200x1000x1200": { dims:[1200,1000,1200], weight:800 },
  "PLS 1200x800x450": { dims:[1200,800,450], weight:450 },
  "PLS 1200x800x650": { dims:[1200,800,650], weight:450 },
  "PLS 1200x800x800": { dims:[1200,800,800], weight:450 },
  "PLS 1200x800x1000": { dims:[1200,800,1000], weight:450 },
  "PLS 1200x800x1100": { dims:[1200,800,1100], weight:450 },
  "PLS 1200x800x1200": { dims:[1200,800,1200], weight:450 },
  "PLS 1200x1000x450": { dims:[1200,1000,450], weight:500 },
  "PLS 1200x1000x650": { dims:[1200,1000,650], weight:500 },
  "PLS 1200x1000x800": { dims:[1200,1000,800], weight:500 },
  "PLS 1200x1000x1000": { dims:[1200,1000,1000], weight:500 },
  "PLS 1200x1000x1100": { dims:[1200,1000,1100], weight:500 },
  "PLS 1200x1000x1200": { dims:[1200,1000,1200], weight:500 },
};

const boxesDiv = document.getElementById('boxes');
const summaryPills = document.getElementById('summaryPills');

function conciseDims(dims){ return `${dims[0]}√ó${dims[1]}√ó${dims[2]} mm`; }

function createBoxRow(defaults={}){
  const container = document.createElement('div');
  container.className = 'box-item';
  let options = "";
  Object.keys(BOX_CATALOGUE).forEach(name=>{
    const sel = defaults.box_type===name?"selected":"";
    options+=`<option value="${name}" ${sel}>${name}</option>`;
  });

  container.innerHTML = `
    <div class="box-top">
      <div style="flex:1;">
        <label class="muted">Box Type</label>
        <select class="b-type">${options}</select>
        <div class="dims muted small-dims"></div>
      </div>
      <div style="width:110px;">
        <label class="muted">Qty (opt)</label>
        <input class="b-qty" type="number" min="1" placeholder="auto" value="${defaults.quantity||''}" />
      </div>
      <div style="width:120px;">
        <label class="muted">Max payload (kg)</label>
        <input class="b-payload" type="number" placeholder="kg" value="${defaults.max_payload_kg||''}" />
      </div>
      <div style="width:56px; display:flex; align-items:flex-end; justify-content:flex-end;">
        <button class="remove small secondary">‚úï</button>
      </div>
    </div>
  `;
  boxesDiv.appendChild(container);

  const sel = container.querySelector('.b-type');
  const dimsNode = container.querySelector('.small-dims');
  const payloadNode = container.querySelector('.b-payload');

  function updateFields(){
    const chosen = BOX_CATALOGUE[sel.value];
    dimsNode.innerText = conciseDims(chosen.dims);
    payloadNode.value = defaults.max_payload_kg ?? chosen.weight;
    rebuildSummaryPills();
  }
  sel.onchange = updateFields;
  container.querySelector('.remove').onclick = ()=>{ container.remove(); rebuildSummaryPills(); };

  updateFields();
}

document.getElementById('addBox').onclick = ()=>createBoxRow();
createBoxRow();

document.getElementById('resetBtn').onclick = ()=>{
  boxesDiv.innerHTML='';
  createBoxRow();
  document.getElementById('source').value='';
  document.getElementById('dest').value='';
  document.getElementById('truckNames').value='';
  document.getElementById('truckDims').value='';
  document.getElementById('truckPayloads').value='';
  rebuildSummaryPills();
};

function rebuildSummaryPills(){
  summaryPills.innerHTML='';
  boxesDiv.querySelectorAll('.box-item').forEach(n=>{
    const type=n.querySelector('.b-type').value;
    const l=n.querySelector('.small-dims')?.innerText||'';
    const pill=document.createElement('div');
    pill.className='pill';
    pill.innerText=`${type} ‚Ä¢ ${l}`;
    summaryPills.appendChild(pill);
  });
}

function buildRequest(){
  const boxes=[];
  boxesDiv.querySelectorAll('.box-item').forEach(n=>{
    const type=n.querySelector('.b-type').value;
    const [l,w,h]=BOX_CATALOGUE[type].dims.map(Number);
    const payload=n.querySelector('.b-payload').value?parseFloat(n.querySelector('.b-payload').value):null;
    const qty=n.querySelector('.b-qty').value?parseInt(n.querySelector('.b-qty').value):null;
    boxes.push({ box_type:type, external_length_mm:l, external_width_mm:w, external_height_mm:h, max_payload_kg:payload, quantity:qty });
  });

  const truckNames=(document.getElementById('truckNames').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const truckDimsRaw=(document.getElementById('truckDims').value||'').split(';').map(s=>s.trim()).filter(Boolean);
  const truckPayloads=(document.getElementById('truckPayloads').value||'').split(',').map(s=>s.trim()).filter(Boolean);

  let trucks=null;
  if(truckNames.length && truckDimsRaw.length===truckNames.length){
    trucks=truckNames.map((name,i)=>{
      const dims=truckDimsRaw[i].split('x').map(x=>parseFloat(x));
      return { name, internal_length_mm:dims[0], internal_width_mm:dims[1], internal_height_mm:dims[2], payload_kg: truckPayloads[i]?parseFloat(truckPayloads[i]):undefined };
    });
  }

  const route_types=[];
  if(document.getElementById('highway').checked) route_types.push('Highway');
  if(document.getElementById('semi').checked) route_types.push('Semi-Urban');
  if(document.getElementById('village').checked) route_types.push('Village');

  return { boxes, trucks, route_source:document.getElementById('source').value||undefined, route_dest:document.getElementById('dest').value||undefined, route_types };
}

// --- Render results ---
function renderResultsArray(data){
  if(!Array.isArray(data)||data.length===0){
    document.getElementById('results').innerHTML=`<div class="muted">No trucks returned.</div>`;
    return;
  }
  const container=document.createElement('div');
  container.className='results-grid';

  data.forEach(r=>{
    const truckName=r.truck_name||'Truck';
    const units=r.units_packed_total??0;
    const cube=r.cube_utilisation_pct??0;
    const payloadKg=r.payload_used_kg??0;
    const payloadPct=r.payload_used_pct??0;
    const boxes=r.box_counts_by_type||{};

    const card=document.createElement('div');
    card.className='truck-card';

    const title=document.createElement('div');
    title.style.display='flex';
    title.style.justifyContent='space-between';
    title.style.alignItems='center';
    const h=document.createElement('div');
    h.innerHTML=`<div style="font-weight:800;font-size:14px;color:var(--accent-contrast)">${truckName}</div>
                 <div class="metric-small muted">${units} units</div>`;
    title.appendChild(h);
    card.appendChild(title);

    const metrics=document.createElement('div');
    metrics.style.display='flex';
    metrics.style.justifyContent='space-between';
    metrics.style.gap='8px';
    metrics.style.marginTop='10px';

    const left=document.createElement('div');
    left.innerHTML=`<div class="metric">${cube.toFixed(2)}%</div><div class="metric-small">Cube Utilisation</div>`;
    const right=document.createElement('div');
    right.style.textAlign='right';
    right.innerHTML=`<div class="metric">${payloadKg} kg</div><div class="metric-small">Payload Used (${payloadPct}%)</div>`;
    metrics.appendChild(left);
    metrics.appendChild(right);
    card.appendChild(metrics);

    // Box breakdown
    const list=document.createElement('div');
    list.style.marginTop='10px';
    list.innerHTML=`<div style="font-weight:700;font-size:13px;color:#0f172a">Boxes</div>`;
    const ul=document.createElement('div');
    ul.style.marginTop='6px';
    for(const [k,v] of Object.entries(boxes)){
      const row=document.createElement('div');
      row.style.display='flex';
      row.style.justifyContent='space-between';
      row.style.fontSize='13px';
      row.style.color='#123';
      row.style.marginTop='6px';
      row.innerHTML=`<div style="color:var(--muted)">${k}</div><div style="font-weight:800">${v}</div>`;
      ul.appendChild(row);
    }
    list.appendChild(ul);
    card.appendChild(list);

    if(r.notes&&r.notes.length){
      const note=document.createElement('div');
      note.style.marginTop='10px';
      note.style.fontSize='12px';
      note.style.color='var(--muted)';
      note.innerText='Notes: '+r.notes.slice(0,2).join(' ‚Ä¢ ');
      card.appendChild(note);
    }

    container.appendChild(card);
  });

  const resultsNode=document.getElementById('results');
  resultsNode.innerHTML='';
  resultsNode.appendChild(container);
}

// --- Optimize button ---
document.getElementById('optBtn').onclick=async ()=>{
  const btn=document.getElementById('optBtn');
  const resultsNode=document.getElementById('results');
  const payload=buildRequest();

  btn.disabled=true;
  btn.innerHTML=`<span class="loader"></span>Optimizing...`;
  resultsNode.innerHTML=`<div style="display:flex;gap:8px;align-items:center;"><div class="loader"></div><div>Running optimization...</div></div>`;

  try{
    const resp=await fetch('http://127.0.0.1:8000/api/optimize',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });

    if(!resp.ok){
      const text=await resp.text();
      resultsNode.innerHTML=`<pre>Error ${resp.status}: ${text}</pre>`;
      return;
    }

    const data=await resp.json();
    if(!data||(Array.isArray(data)&&data.length===0)){
      resultsNode.innerHTML=`<div class="muted">No trucks returned by server.</div>`;
      return;
    }

    if(Array.isArray(data)){
      renderResultsArray(data);
    } else if(data&&typeof data==='object'){
      if(data.truck_name||data.units_packed_total){
        renderResultsArray([data]);
      } else {
        resultsNode.innerHTML=`<pre>${JSON.stringify(data,null,2)}</pre>`;
      }
    } else {
      resultsNode.innerHTML=`<pre>Unexpected response: ${String(data)}</pre>`;
    }

  }catch(err){
    resultsNode.innerHTML=`<pre>Error: ${err && err.message?err.message:String(err)}</pre>`;
  }finally{
    btn.disabled=false;
    btn.innerHTML='‚ö° Optimize Trucks';
    rebuildSummaryPills();
  }
};

rebuildSummaryPills();
</script>
</body>
</html>
