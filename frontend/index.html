<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>üöõ Truck Optimiser ‚Äî 3D Demo</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{
  --bg-1:#f7fbf9;
  --bg-2:#eef6f1;
  --card:#ffffff;
  --accent:#16a34a;
  --accent-2:#10b981;
  --muted:#6b7280;
  --panel-shadow:0 8px 30px rgba(2,6,23,0.06);
  --glass:rgba(255,255,255,0.6);
  --accent-contrast:#063f2f;
}
html,body{height:100%;}
body{
  font-family:Inter,sans-serif;
  background:linear-gradient(135deg,var(--bg-1),var(--bg-2));
  color:#0f172a;
  padding:28px;
  line-height:1.45;
  margin:0;
}

h2{
  margin:0 0 12px 0;
  font-size:18px;
  font-weight:700;
  color:var(--accent-contrast);
  display:flex;
  align-items:center;
  gap:10px;
}

.card{
  background:var(--card);
  border-radius:14px;
  padding:18px;
  box-shadow:var(--panel-shadow);
  margin-bottom:18px;
  transition:transform .16s ease;
}

.card.small{padding:12px;border-radius:12px;}
label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted);font-weight:600;}
input[type="text"], input[type="number"], select{
  width:100%;padding:8px 10px;border-radius:10px;border:1px solid #e6eef0;background:#fbfdfb;
}
.row{display:flex;gap:12px;flex-wrap:wrap;}
.col{flex:1;min-width:200px;}
button{
  background:linear-gradient(90deg,var(--accent),var(--accent-2));
  color:white;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;
  box-shadow:0 6px 18px rgba(16,185,129,0.14);
}
button.secondary{background:#f3f4f6;color:#111;box-shadow:none;border:1px solid #e6eef0;}
button:disabled{opacity:.6;cursor:wait;}
.muted{color:var(--muted);font-size:13px;}
.small{font-size:13px;padding:6px 10px;}
.box-item{
  border:1px solid #eef2f7;
  padding:12px;
  border-radius:12px;
  margin-bottom:10px;
  background:linear-gradient(180deg,#ffffff,#fbfffb);
  display:flex;flex-direction:column;gap:8px;
}
.box-top{display:flex;gap:12px;align-items:center;}
.box-top .meta{font-size:13px;color:#0f172a;font-weight:600;}
.dims{font-size:12px;color:var(--muted);margin-top:4px;}
.results-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px;}
.truck-card{
  padding:12px;border-radius:10px;background:linear-gradient(180deg,#ffffff,#f7fff7);border:1px solid #ecfdf5;
  position:relative;
}
.metric{font-weight:700;font-size:18px;color:var(--accent-contrast);}
.metric-small{font-size:12px;color:var(--muted);}
.loader{
  display:inline-block;width:18px;height:18px;
  border-radius:50%;
  border:3px solid rgba(255,255,255,0.2);
  border-top-color:white;
  animation:spin 1s linear infinite;
  margin-right:8px;
}
@keyframes spin{to{transform:rotate(360deg)}}
.boxes-compact{display:flex;gap:10px;flex-wrap:wrap;}
.pill{
  background:linear-gradient(90deg,#ecfdf5,#dcfce7);
  border:1px solid #bbf7d0;
  padding:6px 8px;border-radius:999px;font-size:12px;color:#065f46;font-weight:700;
}
.note{font-size:12px;color:var(--muted);margin-top:8px;}

/* 3D Visualization Styles */
.viz-container {
  width: 100%;
  height: 300px;
  border-radius: 8px;
  overflow: hidden;
  margin-top: 12px;
  border: 1px solid #e6eef0;
  position: relative;
}

.viz-controls {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 100;
  display: flex;
  gap: 6px;
}

.viz-control-btn {
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid #ddd;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  transition: background 0.2s;
}

.viz-control-btn:hover {
  background: rgba(255, 255, 255, 1);
}

.viz-control-btn.active {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}

.legend {
  position: absolute;
  bottom: 10px;
  left: 10px;
  background: rgba(255, 255, 255, 0.95);
  padding: 8px 12px;
  border-radius: 6px;
  font-size: 11px;
  z-index: 100;
  max-width: 200px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
}

.legend-color {
  width: 12px;
  height: 12px;
  border-radius: 2px;
  border: 1px solid #ccc;
}
</style>
</head>
<body>

<div class="card">
  <h2>üì¶ Custom Outer Box Details</h2>
  <div id="boxes"></div>
  <div style="margin-top:10px;">
    <button id="addBox" class="small">+ Add Another Box Type</button>
    <span class="muted" style="margin-left:12px;">Pick from PRD catalogue. Edit qty or payload if needed.</span>
  </div>
</div>

<div class="card">
  <h2>üõ£Ô∏è Route & Trucks</h2>
  <div class="row">
    <div class="col">
      <label>Source</label>
      <input id="source" type="text" placeholder="City or depot" />
    </div>
    <div class="col">
      <label>Destination</label>
      <input id="dest" type="text" placeholder="City or depot" />
    </div>
  </div>

  <div style="margin-top:12px" class="row">
    <div class="col">
      <label>Route Type</label>
      <div style="display:flex; gap:12px; align-items:center;">
        <label><input type="checkbox" id="highway" /> Highway</label>
        <label><input type="checkbox" id="semi" /> Semi-Urban</label>
        <label><input type="checkbox" id="village" /> Village</label>
      </div>
    </div>

    <div class="col">
      <label>Custom Trucks (optional)</label>
      <input id="truckNames" placeholder="22 ft Truck,32 ft Single Axle,32 ft Multi Axle" />
      <div style="display:flex; gap:8px; margin-top:6px;">
        <input id="truckDims" placeholder="6700x2440x2440;9750x2440x2440;9750x2440x2440" />
        <input id="truckPayloads" placeholder="7500,9000,16000" />
      </div>
      <div class="note">Leave blank to use default PRD trucks.</div>
    </div>
  </div>
</div>

<div style="display:flex; gap:14px; margin-bottom:18px;">
  <button id="optBtn">‚ö° Optimize Trucks</button>
  <button id="resetBtn" class="secondary">Reset</button>
  <div style="flex:1"></div>
  <div class="boxes-compact" id="summaryPills"></div>
</div>

<div class="card">
  <h2>üìä Results with 3D Visualization</h2>
  <div id="results" class="muted">No results yet.</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
const BOX_CATALOGUE = {
  "Crate 400x300x120": { dims:[400,300,120], weight:15 },
  "Crate 400x300x235": { dims:[400,300,235], weight:15 },
  "Crate 600x400x120": { dims:[600,400,120], weight:15 },
  "Crate 600x400x180": { dims:[600,400,180], weight:15 },
  "Crate 600x400x235": { dims:[600,400,235], weight:15 },
  "Crate 600x400x348": { dims:[600,400,348], weight:15 },
  "PP Box": { dims:[1900,1200,800], weight:15 },
  "FLC 1200x1000x595": { dims:[1200,1000,595], weight:800 },
  "FLC 1200x1000x795": { dims:[1200,1000,795], weight:800 },
  "FLC 1200x1000x975": { dims:[1200,1000,975], weight:800 },
  "FLC 1200x1000x1200": { dims:[1200,1000,1200], weight:800 },
  "PLS 1200x800x450": { dims:[1200,800,450], weight:450 },
  "PLS 1200x800x650": { dims:[1200,800,650], weight:450 },
  "PLS 1200x800x800": { dims:[1200,800,800], weight:450 },
  "PLS 1200x800x1000": { dims:[1200,800,1000], weight:450 },
  "PLS 1200x800x1100": { dims:[1200,800,1100], weight:450 },
  "PLS 1200x800x1200": { dims:[1200,800,1200], weight:450 },
  "PLS 1200x1000x450": { dims:[1200,1000,450], weight:500 },
  "PLS 1200x1000x650": { dims:[1200,1000,650], weight:500 },
  "PLS 1200x1000x800": { dims:[1200,1000,800], weight:500 },
  "PLS 1200x1000x1000": { dims:[1200,1000,1000], weight:500 },
  "PLS 1200x1000x1100": { dims:[1200,1000,1100], weight:500 },
  "PLS 1200x1000x1200": { dims:[1200,1000,1200], weight:500 },
};

// Color palette for different box types
const BOX_COLORS = [
  0xff6b6b, 0x4ecdc4, 0x45b7d1, 0xf9ca24, 0xf0932b,
  0xeb4d4b, 0x6c5ce7, 0xa55eea, 0x26de81, 0xfd79a8,
  0xe17055, 0x74b9ff, 0x00b894, 0xfdcb6e, 0xe84393
];

const boxesDiv = document.getElementById('boxes');
const summaryPills = document.getElementById('summaryPills');

function conciseDims(dims){ return `${dims[0]}√ó${dims[1]}√ó${dims[2]} mm`; }

function createBoxRow(defaults={}){
  const container = document.createElement('div');
  container.className = 'box-item';
  let options = "";
  Object.keys(BOX_CATALOGUE).forEach(name=>{
    const sel = defaults.box_type===name?"selected":"";
    options+=`<option value="${name}" ${sel}>${name}</option>`;
  });

  container.innerHTML = `
    <div class="box-top">
      <div style="flex:1;">
        <label class="muted">Box Type</label>
        <select class="b-type">${options}</select>
        <div class="dims muted small-dims"></div>
      </div>
      <div style="width:110px;">
        <label class="muted">Qty (opt)</label>
        <input class="b-qty" type="number" min="1" placeholder="auto" value="${defaults.quantity||''}" />
      </div>
      <div style="width:120px;">
        <label class="muted">Max payload (kg)</label>
        <input class="b-payload" type="number" placeholder="kg" value="${defaults.max_payload_kg||''}" />
      </div>
      <div style="width:56px; display:flex; align-items:flex-end; justify-content:flex-end;">
        <button class="remove small secondary">‚úï</button>
      </div>
    </div>
  `;
  boxesDiv.appendChild(container);

  const sel = container.querySelector('.b-type');
  const dimsNode = container.querySelector('.small-dims');
  const payloadNode = container.querySelector('.b-payload');

  function updateFields(){
    const chosen = BOX_CATALOGUE[sel.value];
    dimsNode.innerText = conciseDims(chosen.dims);
    payloadNode.value = defaults.max_payload_kg ?? chosen.weight;
    rebuildSummaryPills();
  }
  sel.onchange = updateFields;
  container.querySelector('.remove').onclick = ()=>{ container.remove(); rebuildSummaryPills(); };

  updateFields();
}

document.getElementById('addBox').onclick = ()=>createBoxRow();
createBoxRow();

document.getElementById('resetBtn').onclick = ()=>{
  boxesDiv.innerHTML='';
  createBoxRow();
  document.getElementById('source').value='';
  document.getElementById('dest').value='';
  document.getElementById('truckNames').value='';
  document.getElementById('truckDims').value='';
  document.getElementById('truckPayloads').value='';
  document.getElementById('results').innerHTML = 'No results yet.';
  rebuildSummaryPills();
};

function rebuildSummaryPills(){
  summaryPills.innerHTML='';
  boxesDiv.querySelectorAll('.box-item').forEach(n=>{
    const type=n.querySelector('.b-type').value;
    const l=n.querySelector('.small-dims')?.innerText||'';
    const pill=document.createElement('div');
    pill.className='pill';
    pill.innerText=`${type} ‚Ä¢ ${l}`;
    summaryPills.appendChild(pill);
  });
}

function buildRequest(){
  const boxes=[];
  boxesDiv.querySelectorAll('.box-item').forEach(n=>{
    const type=n.querySelector('.b-type').value;
    const [l,w,h]=BOX_CATALOGUE[type].dims.map(Number);
    const payload=n.querySelector('.b-payload').value?parseFloat(n.querySelector('.b-payload').value):null;
    const qty=n.querySelector('.b-qty').value?parseInt(n.querySelector('.b-qty').value):null;
    boxes.push({ box_type:type, external_length_mm:l, external_width_mm:w, external_height_mm:h, max_payload_kg:payload, quantity:qty });
  });

  const truckNames=(document.getElementById('truckNames').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  const truckDimsRaw=(document.getElementById('truckDims').value||'').split(';').map(s=>s.trim()).filter(Boolean);
  const truckPayloads=(document.getElementById('truckPayloads').value||'').split(',').map(s=>s.trim()).filter(Boolean);

  let trucks=null;
  if(truckNames.length && truckDimsRaw.length===truckNames.length){
    trucks=truckNames.map((name,i)=>{
      const dims=truckDimsRaw[i].split('x').map(x=>parseFloat(x));
      return { name, internal_length_mm:dims[0], internal_width_mm:dims[1], internal_height_mm:dims[2], payload_kg: truckPayloads[i]?parseFloat(truckPayloads[i]):undefined };
    });
  }

  const route_types=[];
  if(document.getElementById('highway').checked) route_types.push('Highway');
  if(document.getElementById('semi').checked) route_types.push('Semi-Urban');
  if(document.getElementById('village').checked) route_types.push('Village');

  return { boxes, trucks, route_source:document.getElementById('source').value||undefined, route_dest:document.getElementById('dest').value||undefined, route_types };
}

// --- API Call Logic (Newly Added) ---
document.getElementById('optBtn').onclick = async () => {
    const btn = document.getElementById('optBtn');
    const resultsNode = document.getElementById('results');
    
    btn.disabled = true;
    btn.innerHTML = `<span class="loader"></span> Optimizing...`;
    resultsNode.innerHTML = `<div class="muted">Processing your request... please wait.</div>`;
    
    const requestData = buildRequest();

    try {
        // NOTE: You may need to change this URL to match where your Python server is running.
        const response = await fetch('http://127.0.0.1:8000/api/optimize', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData),
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ detail: 'Failed to parse error response from server.' }));
            throw new Error(errorData.detail || `Request failed with status ${response.status}`);
        }

        const resultsData = await response.json();
        renderResultsArray(resultsData);

    } catch (error) {
        console.error('Error optimizing:', error);
        resultsNode.innerHTML = `<div class="muted" style="color:#d9534f; font-weight:bold;">An error occurred: ${error.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = `‚ö° Optimize Trucks`;
    }
};


// --- 3D Visualization and Results Rendering ---
function create3DVisualization(container, truckData) {
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0xf0f8ff);
  
  const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 20000);
  const renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(container.clientWidth, container.clientHeight);
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  
  container.appendChild(renderer.domElement);

  const truckDims = truckData.truck_dimensions || {};
  const truckLength = truckDims.length_mm || 9750;
  const truckWidth = truckDims.width_mm || 2440;
  const truckHeight = truckDims.height_mm || 2440;
  
  const truckGeometry = new THREE.BoxGeometry(truckLength, truckHeight, truckWidth);
  const truckMaterial = new THREE.MeshBasicMaterial({ 
    color: 0x333333, 
    wireframe: true, 
    transparent: true, 
    opacity: 0.3 
  });
  const truckMesh = new THREE.Mesh(truckGeometry, truckMaterial);
  scene.add(truckMesh);

  const floorGeometry = new THREE.PlaneGeometry(truckLength, truckWidth);
  const floorMaterial = new THREE.MeshLambertMaterial({ 
    color: 0xcccccc, 
    transparent: true, 
    opacity: 0.5 
  });
  const floor = new THREE.Mesh(floorGeometry, floorMaterial);
  floor.rotation.x = -Math.PI / 2;
  floor.position.y = -truckHeight / 2;
  floor.receiveShadow = true;
  scene.add(floor);

  const boxTypes = Object.keys(truckData.box_counts_by_type || {});
  const colorMap = {};
  boxTypes.forEach((type, index) => {
    colorMap[type] = BOX_COLORS[index % BOX_COLORS.length];
  });

  if (truckData.placements_sample && truckData.placements_sample.length > 0) {
    truckData.placements_sample.forEach((placement, index) => {
      if (!placement.position || !placement.dims_mm) return;
      
      const [x, y, z] = placement.position;
      const [width, height, depth] = placement.dims_mm;
      
      if (!width || !height || !depth || width <= 0 || height <= 0 || depth <= 0) return;
      
      const boxGeometry = new THREE.BoxGeometry(width, height, depth);
      const boxColor = colorMap[placement.name] || 0x888888;
      const boxMaterial = new THREE.MeshLambertMaterial({ 
        color: boxColor,
        transparent: true,
        opacity: 0.8
      });
      
      const edges = new THREE.EdgesGeometry(boxGeometry);
      const lineMaterial = new THREE.LineBasicMaterial({ color: 0x000000, opacity: 0.3 });
      const wireframe = new THREE.LineSegments(edges, lineMaterial);
      
      const box = new THREE.Mesh(boxGeometry, boxMaterial);
      
      box.position.set(
        x + width/2 - truckLength/2,
        y + height/2 - truckHeight/2, 
        z + depth/2 - truckWidth/2
      );
      
      wireframe.position.copy(box.position);
      
      box.castShadow = true;
      box.userData = { 
        name: placement.name, 
        weight: placement.weight_kg,
        dims: [width, height, depth],
        originalPosition: [x, y, z]
      };
      
      scene.add(box);
      scene.add(wireframe);
    });
  }

  const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
  scene.add(ambientLight);
  
  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
  directionalLight.position.set(truckLength, truckHeight * 2, truckWidth);
  directionalLight.castShadow = true;
  directionalLight.shadow.mapSize.width = 1024;
  directionalLight.shadow.mapSize.height = 1024;
  scene.add(directionalLight);

  camera.position.set(truckLength * 1.5, truckHeight, truckWidth * 1.5);
  camera.lookAt(0, 0, 0);

  let mouseDown = false;
  let mouseX = 0;
  let mouseY = 0;
  let targetRotationX = 0;
  let targetRotationY = 0;
  let rotationX = 0;
  let rotationY = 0;

  renderer.domElement.addEventListener('mousedown', (e) => {
    mouseDown = true;
    mouseX = e.clientX;
    mouseY = e.clientY;
  });

  renderer.domElement.addEventListener('mousemove', (e) => {
    if (!mouseDown) return;
    const deltaX = e.clientX - mouseX;
    const deltaY = e.clientY - mouseY;
    targetRotationY += deltaX * 0.01;
    targetRotationX += deltaY * 0.01;
    mouseX = e.clientX;
    mouseY = e.clientY;
  });

  renderer.domElement.addEventListener('mouseup', () => { mouseDown = false; });
  renderer.domElement.addEventListener('wheel', (e) => {
    e.preventDefault();
    const scale = e.deltaY > 0 ? 1.1 : 0.9;
    camera.position.multiplyScalar(scale);
  });

  function animate() {
    requestAnimationFrame(animate);
    rotationX += (targetRotationX - rotationX) * 0.1;
    rotationY += (targetRotationY - rotationY) * 0.1;
    
    const radius = camera.position.length();
    camera.position.x = radius * Math.sin(rotationY) * Math.cos(rotationX);
    camera.position.y = radius * Math.sin(rotationX);
    camera.position.z = radius * Math.cos(rotationY) * Math.cos(rotationX);
    camera.lookAt(0, 0, 0);
    
    renderer.render(scene, camera);
  }
  animate();

  const resizeObserver = new ResizeObserver(() => {
    const width = container.clientWidth;
    const height = container.clientHeight;
    camera.aspect = width / height;
    camera.updateProjectionMatrix();
    renderer.setSize(width, height);
  });
  resizeObserver.observe(container);

  return { scene, camera, renderer, colorMap };
}

function renderResultsArray(data){
  if(!Array.isArray(data)||data.length===0){
    document.getElementById('results').innerHTML=`<div class="muted">No viable packing solution found for the given boxes and trucks.</div>`;
    return;
  }
  const container=document.createElement('div');
  container.className='results-grid';

  data.forEach((r, truckIndex) => {
    const truckName=r.truck_name||'Truck';
    const units=r.units_packed_total??0;
    const cube=r.cube_utilisation_pct??0;
    const payloadKg=r.payload_used_kg??0;
    const payloadPct=r.payload_used_pct??0;
    const boxes=r.box_counts_by_type||{};

    const card=document.createElement('div');
    card.className='truck-card';
    card.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div style="font-weight:800;font-size:14px;color:var(--accent-contrast)">${truckName}</div>
          <div class="metric-small muted">${units} units</div>
        </div>
      </div>
      <div style="display:flex; justify-content:space-between; gap:8px; margin-top:10px;">
        <div>
          <div class="metric">${cube.toFixed(2)}%</div>
          <div class="metric-small">Cube Utilisation</div>
        </div>
        <div style="text-align:right;">
          <div class="metric">${payloadKg.toFixed(1)} kg</div>
          <div class="metric-small">Payload Used (${(payloadPct||0).toFixed(1)}%)</div>
        </div>
      </div>
    `;

    if (units > 0) {
      const vizContainer = document.createElement('div');
      vizContainer.className = 'viz-container';
      vizContainer.id = `viz-${truckIndex}`;
      card.appendChild(vizContainer);
      
      setTimeout(() => {
        try {
          const viz = create3DVisualization(vizContainer, r);
          vizContainer.vizData = viz;
          
          if (Object.keys(boxes).length > 0) {
            const legend = document.createElement('div');
            legend.className = 'legend';
            legend.innerHTML = '<div style="font-weight:700;margin-bottom:4px;">Box Types:</div>';
            Object.entries(boxes).forEach(([boxType, count]) => {
              const color = viz.colorMap[boxType] || 0x888888;
              const hexColor = '#' + new THREE.Color(color).getHexString();
              legend.innerHTML += `<div class="legend-item"><div class="legend-color" style="background-color: ${hexColor}"></div><span>${boxType} (${count})</span></div>`;
            });
            vizContainer.appendChild(legend);
          }
        } catch (error) {
          console.error('Error creating 3D visualization:', error);
          vizContainer.innerHTML = '<div style="padding:20px;text-align:center;color:#666;">3D visualization unavailable</div>';
        }
      }, 100);
    }

    const list=document.createElement('div');
    list.style.marginTop='10px';
    let boxListHTML = `<div style="font-weight:700;font-size:13px;color:#0f172a">Boxes</div><div style="margin-top:6px;">`;
    for(const [k,v] of Object.entries(boxes)){
      boxListHTML += `<div style="display:flex;justify-content:space-between;font-size:13px;color:#123;margin-top:6px;"><div style="color:var(--muted)">${k}</div><div style="font-weight:800">${v}</div></div>`;
    }
    boxListHTML += `</div>`;
    list.innerHTML = boxListHTML;
    card.appendChild(list);

    if(r.notes&&r.notes.length){
      const note=document.createElement('div');
      note.style.marginTop='10px';
      note.style.fontSize='12px';
      note.style.color='var(--muted)';
      note.innerText='Notes: '+r.notes.slice(0,2).join(' ‚Ä¢ ');
      card.appendChild(note);
    }
    container.appendChild(card);
  });

  const resultsNode=document.getElementById('results');
  resultsNode.innerHTML='';
  resultsNode.appendChild(container);
}

// Global functions for 3D controls (not part of original code, but useful)
// These would need controls in the HTML to be useful.
// window.resetView = ...
// window.toggleWireframe = ...
</script>
</body>
</html>